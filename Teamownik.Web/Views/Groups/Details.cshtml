@model Teamownik.Web.Models.GroupDetailsViewModel
@{
ViewData["Title"] = Model.GroupName;
Layout = null;
}

<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>@Model.GroupName</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        body {
            padding-bottom: 80px;
            padding-top: 66px;
            background-color: #f8f9fa;
        }

        .centered-content {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .header-sticky-offset {
            top: 66px;
            z-index: 990;
        }
    </style>
</head>
<body class="bg-light" style="padding-top: 66px; padding-bottom: 80px;">

@await Html.PartialAsync("_Navbar")

<div class="container" style="max-width: 900px;">
    <div class="bg-white p-3 shadow-sm mb-3 rounded-3 position-sticky" style="top: 66px; z-index: 1020;">
        <div class="d-flex align-items-center gap-3">
            <a href="/Groups" class="text-decoration-none fs-4 text-dark"><i class="bi bi-arrow-left"></i></a>
            <div class="fw-bold fs-5 text-dark">Szczegóły grupy</div>
        </div>
    </div>
</div>

<div class="container" style="max-width: 900px;">

    <div class="bg-white shadow-sm p-3 mb-3 rounded-3 mt-3">
        <div class="text-center">
            <h1 class="h5 fw-bold mb-1">@Model.GroupName</h1>
            <p class="text-muted small mb-0">
                @Model.MemberCount członków • Założyciel: @Model.CreatorName
            </p>
        </div>
    </div>

    <ul class="nav nav-underline nav-fill bg-white mb-3 shadow-sm rounded-3" id="groupTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active text-dark fw-bold py-3" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button" role="tab">
                <i class="bi bi-people-fill"></i> <span class="d-none d-sm-inline">Członkowie</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link text-dark fw-bold py-3" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
                <i class="bi bi-chat-dots-fill"></i> <span class="d-none d-sm-inline">Czat</span>
            </button>
        </li>
        @if (Model.IsCreator)
        {
        <li class="nav-item" role="presentation">
            <button class="nav-link text-dark fw-bold py-3" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                <i class="bi bi-gear-fill"></i>
            </button>
        </li>
        }
    </ul>

    <div class="tab-content" id="groupTabsContent">

        <div class="tab-pane fade show active" id="members" role="tabpanel">
            <div class="bg-white p-3 mb-3 border-bottom shadow-sm rounded-3">
                <div class="row text-center g-2">
                    <div class="col-4">
                        <div class="fw-bold fs-5 text-info">@Model.TotalGamesPlayed</div>
                        <div class="small text-muted">Rozegrane</div>
                    </div>
                    <div class="col-4 border-start border-end">
                        <div class="fw-bold fs-5 text-info">@Model.TotalGamesOrganized</div>
                        <div class="small text-muted">Zorganizowane</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold fs-5 text-info">@Model.VIPCount</div>
                        <div class="small text-muted">VIP-owie</div>
                    </div>
                </div>
            </div>

            <div class="pb-5">
                @foreach (var member in Model.Members.OrderByDescending(m => m.IsVIP).ThenByDescending(m => m.GamesOrganized))
                {
                <div class="card border-0 shadow-sm mb-2">
                    <div class="card-body p-3 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-3">
                            <div class="position-relative">
                                <div class="rounded-circle d-flex align-items-center justify-content-center shadow-sm text-white"
                                     style="width: 48px; height: 48px; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    @(string.IsNullOrEmpty(member.UserName) ? "?" : member.UserName.Substring(0, 1).ToUpper())
                                </div>
                                @if (member.IsVIP)
                                {
                                <span class="position-absolute bottom-0 start-100 translate-middle badge rounded-circle bg-warning border border-light p-1">
                                            <i class="bi bi-star-fill text-dark" style="font-size: 0.6rem;"></i>
                                        </span>
                                }
                            </div>
                            <div>
                                <div class="fw-bold d-flex align-items-center gap-1">
                                    @member.UserName
                                    @if (member.IsVIP) { <span class="badge bg-warning text-dark rounded-pill" style="font-size: 0.6rem;">VIP</span> }
                                </div>
                                <div class="small fw-bold text-success">@member.StatsSummary</div>
                            </div>
                        </div>

                        @if (Model.IsCreator && member.UserId != Model.CurrentUserId)
                        {
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm rounded-circle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <form method="post" asp-controller="Groups" asp-action="ToggleVIP">
                                        <input type="hidden" name="groupId" value="@Model.GroupId" />
                                        <input type="hidden" name="userId" value="@member.UserId" />
                                        <button class="dropdown-item" type="submit">
                                            <i class="bi bi-star me-2"></i> @(member.IsVIP ? "Zabierz VIP" : "Nadaj VIP")
                                        </button>
                                    </form>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <button class="dropdown-item text-danger" type="button" data-bs-toggle="modal" data-bs-target="#removeMemberModal-@member.UserId">
                                        <i class="bi bi-trash me-2"></i> Usuń z grupy
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <div class="modal fade" id="removeMemberModal-@member.UserId" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Potwierdź usunięcie</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        Czy na pewno chcesz usunąć użytkownika <strong>@member.UserName</strong> z grupy?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                                        <form method="post" asp-controller="Groups" asp-action="RemoveMember">
                                            <input type="hidden" name="groupId" value="@Model.GroupId" />
                                            <input type="hidden" name="userId" value="@member.UserId" />
                                            <button class="btn btn-danger" type="submit">Usuń</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
        </div>

        <div class="tab-pane fade" id="games" role="tabpanel">
            <div class="card shadow-sm p-5 rounded-4 text-center text-muted border-0">
                <i class="bi bi-calendar-event fs-1 opacity-50 mb-3"></i>
                <div class="small">Lista spotkań grupowych pojawi się tutaj.</div>
            </div>
        </div>

        <div class="tab-pane fade" id="chat" role="tabpanel">
            <div class="d-flex flex-column bg-white shadow-sm rounded-3" style="min-height: calc(100vh - 400px);">

                <div class="flex-grow-1 overflow-auto p-3 d-flex flex-column gap-3" id="messagesContainer">

                    @if (Model.RecentMessages != null && Model.RecentMessages.Any())
                    {
                    @foreach (var msg in Model.RecentMessages)
                    {
                    bool isMine = msg.UserId == Model.CurrentUserId;
                    <div class="d-flex flex-column @(isMine ? "align-items-end" : "align-items-start")">
                        @if (!isMine) { <small class="text-muted ms-1 mb-1" style="font-size: 0.75rem;">@msg.User.FullName</small> }
                        <div class="shadow-sm"
                             style="max-width: 75%; padding: 10px 15px;
                                 border-radius: 1.2rem;
                             @(isMine ? "background-color: #00bcd4; color: white; border-bottom-right-radius: 0.2rem;" : "background-color: #e9ecef; color: #212529; border-bottom-left-radius: 0.2rem;")">
                            @msg.MessageText
                        </div>
                        <small class="text-muted mt-1 mx-1" style="font-size: 0.7rem;">@msg.SentAt.ToLocalTime().ToString("HH:mm")</small>
                    </div>
                    }
                    }
                    else
                    {
                    <div class="text-center my-auto opacity-50" id="emptyChatPlaceholder">
                        <i class="bi bi-chat-dots fs-1"></i>
                        <p>Tu jest cicho... Napisz coś!</p>
                    </div>
                    }
                </div>

                <div class="bg-white p-3 border-top">
                    <form id="chatForm" class="input-group">
                        @Html.AntiForgeryToken()
                        <input type="text" id="messageInput" class="form-control rounded-pill bg-light border-0 px-3" placeholder="Napisz wiadomość..." required autocomplete="off">
                        <button class="btn btn-info rounded-circle ms-2 shadow-sm text-white" style="width: 40px; height: 40px;" type="submit" id="sendButton">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        @if (Model.IsCreator)
        {
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <div class="pb-5">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body">
                        <h5 class="card-title fw-bold">Dodaj członka</h5>
                        <p class="text-muted small">Wpisz adres email użytkownika, aby dodać go do grupy.</p>
                        <form method="post" asp-controller="Groups" asp-action="AddMemberByUsername">
                            <input type="hidden" name="groupId" value="@Model.GroupId" />
                            <div class="input-group mb-3">
                                <input type="text" name="username" class="form-control" placeholder="Email użytkownika" required>
                                <button class="btn btn-dark" type="submit">Dodaj</button>
                            </div>
                        </form>
                    </div>
                </div>

                <hr class="my-4">

                <button type="button" class="btn btn-outline-danger w-100 py-3 rounded-4 fw-bold" data-bs-toggle="modal" data-bs-target="#deactivateModal">
                    <i class="bi bi-exclamation-octagon-fill me-2"></i> Dezaktywuj grupę
                </button>
            </div>
        </div>
        }
        else
        {
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <div class="p-4">
                <button type="button" class="btn btn-outline-danger w-100 py-3 rounded-4 fw-bold" data-bs-toggle="modal" data-bs-target="#leaveModal">
                    <i class="bi bi-box-arrow-right me-2"></i> Opuść grupę
                </button>
            </div>
        </div>
        }
    </div>

</div>

<div class="modal fade" id="deactivateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Potwierdź dezaktywację</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Czy na pewno chcesz dezaktywować grupę <strong>@Model.GroupName</strong>? Nie można tego cofnąć.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <form method="post" asp-action="Deactivate" asp-route-id="@Model.GroupId">
                    @Html.AntiForgeryToken()
                    <button class="btn btn-danger" type="submit">Dezaktywuj</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="leaveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Potwierdź opuszczenie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Czy na pewno chcesz opuścić grupę <strong>@Model.GroupName</strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <form method="post" asp-action="Leave" asp-route-id="@Model.GroupId">
                    @Html.AntiForgeryToken()
                    <button class="btn btn-danger" type="submit">Opuść</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999; margin-top: 70px;">
    @if (TempData["Success"] != null)
    {
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>Sukces!</strong> @TempData["Success"]
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    }

    @if (TempData["Error"] != null)
    {
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-x-circle-fill me-2"></i>
                <strong>Błąd!</strong> @TempData["Error"]
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    }

    @if (TempData["Warning"] != null)
    {
    <div id="warningToast" class="toast align-items-center text-dark bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>Uwaga!</strong> @TempData["Warning"]
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    }
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var toastElList = [].slice.call(document.querySelectorAll('.toast'));
        var toastList = toastElList.map(function(toastEl) {
            return new bootstrap.Toast(toastEl, {
                autohide: true,
                delay: 6000
            });
        });
        toastList.forEach(function(toast) {
            toast.show();
        });
    });

    const groupId = @Model.GroupId;
    const currentUserId = "@Model.CurrentUserId";
    const messagesContainer = document.getElementById('messagesContainer');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const emptyChatPlaceholder = document.getElementById('emptyChatPlaceholder');

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .configureLogging(signalR.LogLevel.Information)
        .build();

    function appendMessage(senderName, messageText, sentTime, senderId) {
        const isMine = senderId === currentUserId;
        const alignClass = isMine ? "align-items-end" : "align-items-start";
        const messageColor = isMine
            ? "background-color: #00bcd4; color: white; border-bottom-right-radius: 0.2rem;"
            : "background-color: #e9ecef; color: #212529; border-bottom-left-radius: 0.2rem;";

        const msgHtml = `
            <div class="d-flex flex-column ${alignClass}">
                ${!isMine ? `<small class="text-muted ms-1 mb-1" style="font-size: 0.75rem;">${senderName}</small>` : ''}
                <div class="shadow-sm"
                     style="max-width: 75%; padding: 10px 15px; 
                     border-radius: 1.2rem;
                     ${messageColor}">
                    ${messageText}
                </div>
                <small class="text-muted mt-1 mx-1" style="font-size: 0.7rem;">${sentTime}</small>
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', msgHtml);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        const currentPlaceholder = document.getElementById('emptyChatPlaceholder');
        if (currentPlaceholder) currentPlaceholder.remove();
    }

    connection.on("ReceiveMessage", function (senderName, messageText, sentTime, senderId) {
        appendMessage(senderName, messageText, sentTime, senderId);
    });

    connection.start().then(function () {
        console.log("SignalR Connected.");
        connection.invoke("JoinGroup", groupId.toString()).catch(function (err) {
            return console.error(err.toString());
        });
        const chatTab = document.getElementById('chat');
        if (chatTab && chatTab.classList.contains('active')) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }).catch(function (err) {
        return console.error(err.toString());
    });

    chatForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const message = messageInput.value.trim();

        if (message) {
            connection.invoke("SendMessageToGroup", groupId, message).then(() => {
                messageInput.value = "";
            }).catch(function (err) {
                return console.error(err.toString());
            });
        }
    });

    document.getElementById('chat-tab').addEventListener('shown.bs.tab', function () {
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
    });

</script>
</body>
</html>